<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fridge Guardian Dashboard</title>

  <!-- local copies on SPIFFS -->
  <script src="/www/lib/react.min.js"></script>
  <script src="/www/lib/react-dom.min.js"></script>
  <script src="/www/lib/babel.min.js"></script>
  <script src="/www/lib/tailwind.min.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-800 text-white min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      /* ---------- state ---------- */
      const [currentScreen, setCurrentScreen] = useState('dashboard');

      // live status
      const [data, setData] = useState({
        tempF: null,
        doorOpen: false,
        alarm: false,
        voltage_mV: null,
      });

      // graph points
      const [dataPoints, setDataPoints] = useState([]);
      const maxPoints = 100;

      // full history rows
      const [history, setHistory] = useState([]);

      // history row filter (last hour/6Â h/24Â h/ all)
      const [filter, setFilter] = useState('all');

      /* NEWÂ â†’ daily statistics */
      const [avgDays, setAvgDays]   = useState(3); // 3Â day window by default
      const [dailyStats, setDailyStats] = useState([]); // [{date,avg,min,max}, â€¦]

      /* ---------- fetch live status everyÂ 1â€¯s ---------- */
      useEffect(() => {
        const fetchData = async () => {
          try {
            const res  = await fetch('/status');
            const json = await res.json();
            setData(json);

            setDataPoints((prev) => {
              const pts = [...prev, json.tempF];
              if (pts.length > maxPoints) pts.shift();
              return pts;
            });
          } catch (err) {
            console.error('Fetch /status error:', err);
          }
        };

        fetchData();
        const id = setInterval(fetchData, 1000);
        return () => clearInterval(id);
      }, []);

      /* ---------- fetch /history everyÂ 30â€¯s ---------- */
      useEffect(() => {
        const fetchHistory = async () => {
          try {
            const res  = await fetch('/history');
            const text = await res.text();
            const lines = text.trim().split('\n').map((ln) => {
              const [ts, tempF, mV, door, alarm] = ln.split(',');
              return {
                timestamp  : parseInt(ts),
                tempF      : parseFloat(tempF),
                voltage_mV : parseFloat(mV),
                door,
                alarm,
              };
            });
            setHistory(lines);
          } catch (err) {
            console.error('Fetch /history error:', err);
          }
        };

        fetchHistory();
        const id = setInterval(fetchHistory, 30000);
        return () => clearInterval(id);
      }, []);

      /* ---------- derive daily avg/min/max when history or window changes ---------- */
      useEffect(() => {
        const grouped = {};
        const now = Date.now();

        history.forEach((row) => {
          // skip rows outside selected window
          if (avgDays > 0 && now - row.timestamp > avgDays * 86400000) return;

          const date = new Date(row.timestamp).toISOString().split('T')[0];
          if (!grouped[date]) grouped[date] = [];
          grouped[date].push(row.tempF);
        });

        const stats = Object.entries(grouped).map(([date, temps]) => {
          const sum = temps.reduce((a, b) => a + b, 0);
          return {
            date,
            avg : sum / temps.length,
            min : Math.min(...temps),
            max : Math.max(...temps),
          };
        });

        // newest date first
        stats.sort((a, b) => new Date(b.date) - new Date(a.date));
        setDailyStats(stats);
      }, [history, avgDays]);

      /* ---------- draw graph whenever dataPoints change ---------- */
      useEffect(() => {
        const canvas = document.getElementById('tempGraph');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        canvas.width  = canvas.offsetWidth;
        canvas.height = 200;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // grid
        ctx.strokeStyle = 'rgba(255,255,255,0.1)';
        ctx.lineWidth = 1;
        for (let y = 0; y <= 100; y += 20) {
          const yPx = canvas.height - (y / 100) * canvas.height;
          ctx.beginPath();
          ctx.moveTo(0, yPx);
          ctx.lineTo(canvas.width, yPx);
          ctx.stroke();
          ctx.fillStyle = 'rgba(255,255,255,0.5)';
          ctx.fillText(`${y}Â°F`, 5, yPx - 5);
        }

        // line
        if (dataPoints.length) {
          ctx.beginPath();
          dataPoints.forEach((val, idx) => {
            const x = idx * (canvas.width / maxPoints);
            const y = canvas.height - (val / 100) * canvas.height;
            idx === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
          });
          ctx.strokeStyle = '#3b82f6';
          ctx.lineWidth = 2;
          ctx.stroke();
        }
      }, [dataPoints]);

      /* ---------- helpers ---------- */
      const resetGraph   = () => setDataPoints([]);
      const navigate     = (s) => setCurrentScreen(s);

      // filter rows for â€œrawâ€ history table
      const filteredHistory = history.filter((row) => {
        if (filter === 'all') return true;
        const hours =
          filter === 'hour' ? 1 : filter === '6hours' ? 6 : 24;
        return Date.now() - row.timestamp <= hours * 3600000;
      });

      const downloadHistory = () => {
        const csv = [
          'Timestamp,Temp (Â°F),Voltage (mV),Door,Alarm',
          ...history.map((r) =>
            `${new Date(r.timestamp).toISOString()},${r.tempF.toFixed(
              1,
            )},${r.voltage_mV.toFixed(1)},${r.door},${r.alarm}`,
          ),
        ].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'fridge_guardian_history.csv';
        a.click();
        URL.revokeObjectURL(url);
      };

      /* ---------- UI ---------- */
      return (
        <div className="min-h-screen">
          {/* nav bar */}
          <nav className="bg-gray-800 p-4 shadow-lg sticky top-0 z-10">
            <div className="container mx-auto flex flex-col sm:flex-row justify-between items-center">
              <h1 className="text-2xl font-bold text-blue-400 mb-2 sm:mb-0">
                Fridge Guardian
              </h1>
              <div className="space-x-2 sm:space-x-4">
                {['dashboard', 'history', 'settings'].map((key) => (
                  <button
                    key={key}
                    onClick={() => navigate(key)}
                    className={`px-3 py-2 rounded-lg ${
                      currentScreen === key ? 'bg-blue-600' : 'bg-gray-700'
                    } hover:bg-blue-500 transition text-sm sm:text-base`}
                  >
                    {key[0].toUpperCase() + key.slice(1)}
                  </button>
                ))}
              </div>
            </div>
          </nav>

          <div className="container mx-auto p-4 sm:p-6">
            {/* ---------- DASHBOARD ---------- */}
            {currentScreen === 'dashboard' && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                {/* temp card */}
                <div className="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg transform hover:scale-105 transition">
                  <h2 className="text-lg sm:text-xl font-semibold mb-4">
                    Temperature
                  </h2>
                  <p className="text-2xl sm:text-3xl font-bold text-blue-400">
                    {data.tempF ? `${data.tempF.toFixed(1)} Â°F` : '--'}
                  </p>
                  <p className="text-xs sm:text-sm text-gray-400 mt-2">
                    Voltage:{' '}
                    {data.voltage_mV
                      ? `${data.voltage_mV.toFixed(1)} mV`
                      : '--'}
                  </p>
                </div>

                {/* status card */}
                <div className="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg transform hover:scale-105 transition">
                  <h2 className="text-lg sm:text-xl font-semibold mb-4">
                    Status
                  </h2>
                  <p className="text-base sm:text-xl flex items-center">
                    <span className="mr-2">
                      {data.doorOpen ? 'ðŸšª OPEN' : 'ðŸšª CLOSED'}
                    </span>
                    <span
                      className={`w-3 h-3 rounded-full ${
                        data.doorOpen ? 'bg-red-500' : 'bg-green-500'
                      }`}
                    ></span>
                  </p>
                  <p className="text-base sm:text-xl mt-2 flex items-center">
                    <span className="mr-2">
                      {data.alarm ? 'ðŸ”” ON' : 'ðŸ”” OFF'}
                    </span>
                    <span
                      className={`w-3 h-3 rounded-full ${
                        data.alarm ? 'bg-red-500' : 'bg-green-500'
                      }`}
                    ></span>
                  </p>
                </div>

                {/* graph */}
                <div className="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg col-span-1 md:col-span-2">
                  <h2 className="text-lg sm:text-xl font-semibold mb-4">
                    Temperature Trend
                  </h2>
                  <canvas
                    id="tempGraph"
                    className="w-full h-48 sm:h-64"
                  ></canvas>
                  <button
                    onClick={resetGraph}
                    className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition text-sm sm:text-base"
                  >
                    Reset Graph
                  </button>
                </div>
              </div>
            )}

            {/* ---------- HISTORY ---------- */}
            {currentScreen === 'history' && (
              <div className="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg">
                <h2 className="text-lg sm:text-xl font-semibold mb-4">
                  Historical Data
                </h2>

                {/* filter buttons + csv dl */}
                <div className="flex flex-col sm:flex-row justify-between mb-4">
                  <div className="space-x-2 mb-2 sm:mb-0">
                    {[
                      ['hour', 'Last Hour'],
                      ['6hours', '6 Hours'],
                      ['24hours', '24 Hours'],
                      ['all', 'All'],
                    ].map(([val, label]) => (
                      <button
                        key={val}
                        onClick={() => setFilter(val)}
                        className={`px-2 py-1 rounded ${
                          filter === val
                            ? 'bg-blue-600'
                            : 'bg-gray-700 hover:bg-blue-500'
                        } text-xs sm:text-sm`}
                      >
                        {label}
                      </button>
                    ))}
                  </div>
                  <button
                    onClick={downloadHistory}
                    className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-500 text-xs sm:text-sm"
                  >
                    Download CSV
                  </button>
                </div>

                {/* raw rows */}
                <div className="overflow-x-auto">
                  <table className="w-full text-xs sm:text-sm text-left">
                    <thead className="bg-gray-700">
                      <tr>
                        <th className="p-2">Timestamp</th>
                        <th className="p-2">Temp (Â°F)</th>
                        <th className="p-2">Voltage (mV)</th>
                        <th className="p-2">Door</th>
                        <th className="p-2">Alarm</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredHistory.map((r, i) => (
                        <tr
                          key={i}
                          className="border-b border-gray-700"
                        >
                          <td className="p-2">
                            {new Date(r.timestamp).toLocaleString()}
                          </td>
                          <td className="p-2">{r.tempF.toFixed(1)}</td>
                          <td className="p-2">
                            {r.voltage_mV.toFixed(1)}
                          </td>
                          <td className="p-2">{r.door}</td>
                          <td className="p-2">{r.alarm}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                {/* ---------- NEW daily stats ---------- */}
                <div className="mt-8">
                  <h3 className="text-md sm:text-lg font-semibold mb-2">
                    Daily Temperature Stats
                  </h3>
                  <label className="text-sm text-gray-400 mr-2">
                    Show Last
                  </label>
                  <select
                    className="bg-gray-700 text-white p-1 rounded text-sm mb-2"
                    onChange={(e) => setAvgDays(parseInt(e.target.value))}
                    value={avgDays}
                  >
                    <option value={3}>3 Days</option>
                    <option value={7}>7 Days</option>
                    <option value={14}>14 Days</option>
                    <option value={0}>All</option>
                  </select>

                  <table className="w-full text-xs sm:text-sm text-left mt-2">
                    <thead className="bg-gray-700">
                      <tr>
                        <th className="p-2">Date</th>
                        <th className="p-2">Average (Â°F)</th>
                        <th className="p-2">Min (Â°F)</th>
                        <th className="p-2">Max (Â°F)</th>
                      </tr>
                    </thead>
                    <tbody>
                      {dailyStats.map((row) => (
                        <tr
                          key={row.date}
                          className="border-b border-gray-700"
                        >
                          <td className="p-2">{row.date}</td>
                          <td className="p-2">{row.avg.toFixed(1)}</td>
                          <td className="p-2">{row.min.toFixed(1)}</td>
                          <td className="p-2">{row.max.toFixed(1)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* ---------- SETTINGS ---------- */}
            {currentScreen === 'settings' && (
              <div className="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg">
                <h2 className="text-lg sm:text-xl font-semibold mb-4">
                  Settings
                </h2>
                {/* (settings form unchanged) */}
                <!-- keep your existing settings form here -->
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
